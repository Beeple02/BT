<!-- F9: EXCHANGE ANALYTICS — Full institutional market intelligence -->
<div style="display:flex;flex-direction:column;height:100%;overflow:hidden">

<!-- Exchange KPI cards -->
<div class="scards" style="grid-template-columns:repeat(9,1fr);border-bottom:1px solid var(--bdr)">
  <div class="sc"><div class="sc-l">TOTAL MKT CAP</div><div class="sc-v" id="ex-mcap">—</div></div>
  <div class="sc"><div class="sc-l">TOTAL VOLUME</div><div class="sc-v" id="ex-vol">—</div></div>
  <div class="sc"><div class="sc-l">SECURITIES</div><div class="sc-v" id="ex-nsec">—</div></div>
  <div class="sc"><div class="sc-l">VOL INDEX (NER-VIX)</div><div class="sc-v yel" id="ex-vix">—</div></div>
  <div class="sc"><div class="sc-l">AVG SHARPE</div><div class="sc-v" id="ex-sh">—</div></div>
  <div class="sc"><div class="sc-l">CAP CONC (HHI)</div><div class="sc-v" id="ex-hhi">—</div></div>
  <div class="sc"><div class="sc-l">EW INDEX RET</div><div class="sc-v" id="ex-ew">—</div></div>
  <div class="sc"><div class="sc-l">AVG CORR</div><div class="sc-v" id="ex-corr" title="Average pairwise correlation">—</div></div>
  <div class="sc"><div class="sc-l">BREADTH SCORE</div><div class="sc-v" id="ex-breadth">—</div></div>
</div>

<div class="frow">
  <div class="ff"><label>PERIOD</label>
    <select id="ex-rng" onchange="loadExch()">
      <option value="1">1D</option><option value="7" selected>7D</option>
      <option value="30">30D</option><option value="90">90D</option>
    </select>
  </div>
  <div class="ff"><label>SORT BY</label>
    <select id="ex-sort" onchange="renderExchRows()">
      <option value="mcap">MARKET CAP</option>
      <option value="volume">VOLUME</option>
      <option value="chg_pct">% CHANGE</option>
      <option value="volatility">VOLATILITY</option>
      <option value="sharpe">SHARPE</option>
      <option value="max_dd">MAX DRAWDOWN</option>
    </select>
  </div>
  <button class="btn on" onclick="loadExch()">↻ REFRESH</button>
  <span id="ex-updated" style="align-self:flex-end;font-size:9px;color:var(--txt3);padding-bottom:4px"></span>
</div>

<!-- Live trade stream bar -->
<div id="ex-stream-bar" style="height:22px;background:#0a0a0a;border-bottom:1px solid var(--bdr);display:flex;align-items:center;overflow:hidden;flex-shrink:0;position:relative">
  <div style="padding:0 8px;font-size:8px;font-weight:700;letter-spacing:2px;color:var(--txt3);border-right:1px solid var(--bdr);white-space:nowrap;flex-shrink:0">STREAM</div>
  <div id="ex-stream-inner" style="display:flex;white-space:nowrap;gap:0"></div>
  <div style="position:absolute;right:0;top:0;bottom:0;width:30px;background:linear-gradient(-90deg,#0a0a0a,transparent);pointer-events:none"></div>
</div>

<div class="wrow" style="flex:1">

  <!-- Securities table -->
  <div class="win resizable" style="flex:1;border-right:0">
    <div class="wbar">
      <div class="wbar-l"><span class="wnum">1</span><span class="wtitle">CAPITAL FLOW &amp; PERFORMANCE</span></div>
      <div class="wbar-r"><span class="wsub" id="ex-tbl-sub">All securities</span></div>
    </div>
    <div class="scroll">
      <table class="dt">
        <thead><tr>
          <th>TICKER</th><th>NAME</th>
          <th class="r">LAST</th><th class="r">CHG%</th>
          <th class="r">MKT CAP</th><th class="r">VOLUME</th>
          <th class="r">VOL SHR</th><th class="r">CAP SHR</th>
          <th class="r">VOL%pa</th><th class="r">SHARPE</th><th class="r">MAX DD</th>
          <th class="r">MOMENTUM</th><th>ACT</th>
        </tr></thead>
        <tbody id="ex-tbody"><tr><td colspan="12" class="loading">LOADING…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Right: charts -->
  <div class="wcol resizable" style="width:310px">
    <div class="win" style="flex:1;border-bottom:0">
      <div class="wbar"><div class="wbar-l"><span class="wnum">2</span><span class="wtitle">CAPITAL DISTRIBUTION</span></div></div>
      <div class="chart-wrap"><canvas id="ex-cap-c"></canvas></div>
    </div>
    <div class="win" style="flex:1;border-top:0;border-bottom:0">
      <div class="wbar"><div class="wbar-l"><span class="wnum">3</span><span class="wtitle">LARGE TRADES</span><span class="wsub" id="ex-lt-sub"></span></div><div class="wbar-r" style="font-size:9px;color:var(--txt3)">≥100 shares</div></div>
      <div class="scroll" id="ex-large-trades"><div class="loading">—</div></div>
    </div>
    <div class="win" style="flex:1;border-top:0">
      <div class="wbar"><div class="wbar-l"><span class="wnum">4</span><span class="wtitle">ADVANCE / DECLINE</span></div><div class="wbar-r" style="font-size:9px;color:var(--txt3)">% advancing vs declining</div></div>
      <div class="chart-wrap"><canvas id="ex-mom-c"></canvas></div>
    </div>
  </div>

</div>
</div>

<script>
(function(){
let _data=null, _corrData=null;
let _cCap=null, _cMom=null;
let _streamTrades=[], _streamPos=0, _streamRaf=null;
const COLS=['#00e5ff','#ffd600','#00c853','#f44336','#e040fb','#ff8c00','#29b6f6','#ff6d00','#00bfa5','#8d6e63'];

// PAGE_exch_onShow defined below with stream

window.loadExch = async function(){
  const days=document.getElementById('ex-rng').value;
  document.getElementById('ex-tbody').innerHTML='<tr><td colspan="12" class="loading">LOADING…</td></tr>';
  const [r, corrR]=await Promise.all([
    api(`/api/exchange_analytics?days=${days}`),
    api(`/api/correlation_matrix?days=${days}`)
  ]);
  if(!r.ok){ document.getElementById('ex-tbody').innerHTML=`<tr><td colspan="12"><div class="err-banner">${r.d.detail||'Error'}</div></td></tr>`; return; }
  _data=r.d; _corrData=corrR.ok?corrR.d:null;
  const ex=_data.exchange;
  document.getElementById('ex-mcap').textContent=fk(ex.total_market_cap);
  document.getElementById('ex-vol').textContent=fk(ex.total_volume);
  document.getElementById('ex-nsec').textContent=ex.num_securities;
  document.getElementById('ex-vix').textContent=ex.volatility_index+'%';
  const shEl=document.getElementById('ex-sh');
  shEl.textContent=f(ex.avg_sharpe,2); shEl.style.color=gc(ex.avg_sharpe);
  const hhiEl=document.getElementById('ex-hhi');
  hhiEl.textContent=ex.concentration_hhi;
  hhiEl.style.color=ex.concentration_hhi>2500?'var(--dn)':ex.concentration_hhi>1500?'var(--yel)':'var(--up)';
  const ewEl=document.getElementById('ex-ew');
  ewEl.textContent=(ex.avg_return>=0?'+':'')+ex.avg_return+'%';
  ewEl.style.color=gc(ex.avg_return);

  if(_corrData){
    const ac=_corrData.avg_corr;
    const corrEl=document.getElementById('ex-corr');
    corrEl.textContent=ac!=null?ac.toFixed(3):'—';
    corrEl.style.color=ac>0.7?'var(--dn)':ac>0.4?'var(--yel)':'var(--up)';
  }

  const tickers=_data.tickers||[];
  const above=tickers.filter(t=>t.chg_pct>0).length;
  const breadthPct=tickers.length?Math.round(above/tickers.length*100):0;
  const breadthEl=document.getElementById('ex-breadth');
  breadthEl.textContent=breadthPct+'%';
  breadthEl.style.color=breadthPct>60?'var(--up)':breadthPct<40?'var(--dn)':'var(--yel)';

  document.getElementById('ex-updated').textContent='Updated '+new Date().toLocaleTimeString('en-GB');

  // Update avg corr KPI card (panel 3 is now large trades)
  if(_corrData && _corrData.tickers){
    const ac=_corrData.avg_corr;
    const corrEl=document.getElementById('ex-corr');
    if(corrEl){ corrEl.textContent=ac!=null?ac.toFixed(3):'—'; corrEl.style.color=ac>0.7?'var(--dn)':ac>0.4?'var(--yel)':'var(--up)'; }
  }

  renderExchRows();
  renderExchCharts();
};

window.renderExchRows = function(){
  if(!_data) return;
  const srt=document.getElementById('ex-sort').value;
  const sorted=[..._data.tickers].sort((a,b)=>{
    const dir=(srt==='chg_pct'||srt==='sharpe')?-1:srt==='max_dd'?1:-1;
    return (a[srt]<b[srt]?1:-1)*dir;
  });
  const tb=document.getElementById('ex-tbody'); tb.innerHTML='';
  sorted.forEach(s=>{
    const mom=s.chg_pct>2?'▲▲ STRONG':s.chg_pct>0.5?'▲ RISING':s.chg_pct<-2?'▼▼ WEAK':s.chg_pct<-0.5?'▼ FALLING':'◆ FLAT';
    const momColor=s.chg_pct>0.5?'var(--up)':s.chg_pct<-0.5?'var(--dn)':'var(--txt3)';
    const tr=document.createElement('tr');
    tr.className=s.chg_pct>0.5?'up-row':s.chg_pct<-0.5?'dn-row':'';
    tr.innerHTML=`
      <td><strong class="wht">${s.ticker}</strong></td>
      <td class="dim" style="max-width:120px;overflow:hidden;text-overflow:ellipsis">${s.name}</td>
      <td class="r wht">${f(s.last)}</td>
      <td class="r ${s.chg_pct>=0?'up':'dn'}">${fp(s.chg_pct)}</td>
      <td class="r">${fk(s.mcap)}</td>
      <td class="r">${fk(s.volume)}</td>
      <td class="r dim">${s.vol_share_pct}%</td>
      <td class="r dim">${s.mcap_share_pct}%</td>
      <td class="r yel">${s.volatility}%</td>
      <td class="r ${s.sharpe>=0?'up':'dn'}">${f(s.sharpe,2)}</td>
      <td class="r dn">-${s.max_dd}%</td>
      <td class="r" style="color:${momColor};font-size:9px">${mom}</td>
      <td><button class="act-b" onclick="event.stopPropagation();exchQuickOrder('${s.ticker}','buy')">B</button>&nbsp;<button class="act-s" onclick="event.stopPropagation();exchQuickOrder('${s.ticker}','sell')">S</button></td>`;
    tr.onclick=()=>{ sw('tkr'); setTimeout(()=>PAGE_tkr_load&&PAGE_tkr_load(s.ticker),250); };
    tb.appendChild(tr);
  });
  document.getElementById('ex-tbl-sub').textContent=`${sorted.length} securities`;
};

async function renderExchCharts(){
  const top10=[..._data.tickers].sort((a,b)=>b.mcap-a.mcap).slice(0,10);
  _cCap=dc(_cCap);
  _cCap=new Chart(document.getElementById('ex-cap-c'),{type:'bar',
    data:{labels:top10.map(s=>s.ticker),datasets:[{data:top10.map(s=>s.mcap),backgroundColor:COLS.slice(0,10),borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,animation:false,indexAxis:'y',
      plugins:{legend:{display:false},tooltip:{...TT,callbacks:{label:c=>` ${fk(c.parsed.x)}`}}},
      scales:{x:{grid:{color:'#1a1a1a'},ticks:{color:'#444',callback:v=>fk(v)}},y:{grid:{display:false},ticks:{color:'#888'}}}}});

  // Advance/Decline stacked bar: show each ticker's contribution
  const adData=[..._data.tickers].sort((a,b)=>b.chg_pct-a.chg_pct);
  const upTickers=adData.filter(s=>s.chg_pct>0);
  const dnTickers=adData.filter(s=>s.chg_pct<0);
  const flatTickers=adData.filter(s=>s.chg_pct===0);
  _cMom=dc(_cMom);
  _cMom=new Chart(document.getElementById('ex-mom-c'),{type:'bar',
    data:{
      labels:adData.map(s=>s.ticker),
      datasets:[
        {data:adData.map(s=>s.chg_pct>=0?s.chg_pct:0),backgroundColor:'rgba(0,200,83,.75)',borderWidth:0,label:'UP'},
        {data:adData.map(s=>s.chg_pct<0?s.chg_pct:0),backgroundColor:'rgba(244,67,54,.75)',borderWidth:0,label:'DN'},
      ]
    },
    options:{responsive:true,maintainAspectRatio:false,animation:false,
      plugins:{legend:{display:false},tooltip:{...TT,callbacks:{
        title:c=>c[0].label,
        label:c=>c.parsed.y!==0?` ${c.parsed.y.toFixed(2)}%`:null
      }}},
      scales:{
        x:{grid:{color:'#1a1a1a'},ticks:{color:'#444',font:{size:8}},stacked:true},
        y:{grid:{color:'#1a1a1a'},position:'right',ticks:{color:'#444',callback:v=>v+'%'},stacked:true}
      }
    }
  });

  // Large trades feed
  const tr=await api('/api/transactions?type=Trade&limit=100');
  const ltEl=document.getElementById('ex-large-trades');
  if(tr.ok&&Array.isArray(tr.d)){
    const large=tr.d.filter(tx=>Math.abs(tx.quantity||0)>=100).slice(0,30);
    document.getElementById('ex-lt-sub').textContent=large.length?' — '+large.length+' shown':'';
    ltEl.innerHTML=large.length?large.map(tx=>{
      const isBuy=(tx.amount||0)<0;
      const dt=tx.timestamp?new Date(tx.timestamp):null;
      const time=dt?dt.toLocaleTimeString('en-GB',{hour12:false}):'—';
      const val=Math.abs(tx.amount||0);
      return `<div style="display:flex;align-items:center;gap:5px;padding:3px 8px;border-bottom:1px solid rgba(46,46,46,.4);font-size:10px;cursor:pointer" onclick="sw('tkr');setTimeout(()=>PAGE_tkr_load&&PAGE_tkr_load('${tx.ticker}'),200)">
        <span style="font-size:9px;color:var(--txt3);width:44px;font-variant-numeric:tabular-nums">${time}</span>
        <span style="font-weight:700;color:var(--org);width:38px">${tx.ticker}</span>
        <span style="font-weight:700;font-size:9px;color:${isBuy?'var(--up)':'var(--dn)'};width:30px">${isBuy?'BUY':'SELL'}</span>
        <span style="color:var(--wht);width:52px;text-align:right;font-variant-numeric:tabular-nums">${Math.abs(tx.quantity||0).toLocaleString()} sh</span>
        <span style="color:var(--yel);flex:1;text-align:right;font-variant-numeric:tabular-nums">$${f(val,0)}</span>
        <button style="font-size:8px;padding:1px 3px;background:rgba(0,200,83,.12);border:1px solid rgba(0,200,83,.4);color:var(--up);cursor:pointer;font-family:var(--font);font-weight:700" onclick="event.stopPropagation();exchQuickOrder('${tx.ticker}','buy')">B</button>
        <button style="font-size:8px;padding:1px 3px;background:rgba(244,67,54,.12);border:1px solid rgba(244,67,54,.4);color:var(--dn);cursor:pointer;font-family:var(--font);font-weight:700" onclick="event.stopPropagation();exchQuickOrder('${tx.ticker}','sell')">S</button>
      </div>`;
    }).join(''):'<div class="loading" style="padding:12px">No large trades found</div>';
  }
}
window.exchQuickOrder = function(ticker, side) {
  sw('ord');
  setTimeout(()=>{
    const tkSel=document.getElementById('op-tk');
    if(tkSel){tkSel.value=ticker;if(window.opTickerChg)opTickerChg();}
    if(window.opSide) opSide(side);
  }, 300);
};

// ── Live trade stream strip ──────────────────────────────────────────────────
async function updateStream() {
  const r = await api('/api/transactions?type=Trade&limit=30');
  if(!r.ok || !Array.isArray(r.d)) return;
  const known = new Set(_streamTrades.map(t=>t.id||t.timestamp));
  const newTs = r.d.filter(t=>!known.has(t.id||t.timestamp));
  _streamTrades = r.d;
  if(!newTs.length) return;
  // Prepend new trades to stream
  const inner = document.getElementById('ex-stream-inner');
  if(!inner) return;
  newTs.reverse().forEach(tx => {
    const isBuy = (tx.amount||0) < 0;
    const span = document.createElement('span');
    span.style.cssText = `display:inline-flex;align-items:center;gap:4px;padding:0 12px;font-size:9px;border-right:1px solid var(--bdr);white-space:nowrap;color:${isBuy?'var(--up)':'var(--dn)'}`;
    span.innerHTML = `<span style="color:var(--org);font-weight:700">${tx.ticker}</span>
      <span style="font-weight:700">${isBuy?'▲':'▼'}</span>
      <span style="color:var(--wht)">${Math.abs(tx.quantity||0).toLocaleString()}sh</span>
      <span style="color:var(--yel)">$${f(tx.price||0,4)}</span>`;
    span.style.animation = 'tape-flash .9s ease-out';
    inner.prepend(span);
    // keep max 60 items
    while(inner.children.length > 60) inner.removeChild(inner.lastChild);
  });
}
// Scroll the stream continuously
function animateStream() {
  const inner = document.getElementById('ex-stream-inner');
  if(inner) {
    _streamPos -= 0.4;
    if(-_streamPos > inner.scrollWidth) _streamPos = 0;
    inner.style.transform = `translateX(${_streamPos}px)`;
  }
  _streamRaf = requestAnimationFrame(animateStream);
}
window.PAGE_exch_onShow = function(){
  if(!_data) loadExch();
  updateStream();
  if(!_streamRaf) animateStream();
};
setInterval(updateStream, 6000);

})();
</script>
